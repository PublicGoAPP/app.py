import streamlit as st
import requests
from bs4 import BeautifulSoup
from newspaper import Article
import re
from datetime import datetime
import os

# --- CONFIGURACI√ìN DE LA APP ---
st.set_page_config(page_title="Public Go Intelligence", layout="wide", initial_sidebar_state="expanded")

# Estilo personalizado para un look de consultor√≠a de √©lite
st.markdown("""
    <style>
    .main { background-color: #f8f9fa; }
    .stMetric { background-color: #ffffff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
    .stExpander { border: none !important; box-shadow: 0 2px 4px rgba(0,0,0,0.05) !important; margin-bottom: 10px !important; }
    </style>
    """, unsafe_allow_html=True)

# --- CAPA DE INTELIGENCIA: SECCIONES Y AN√ÅLISIS ---
SECCIONES = {
    "üèõÔ∏è Gobierno y Transici√≥n": ["fiscal", "devoe", "amnist√≠a", "saab", "asamblea", "nombramiento", "renuncia", "delcy"],
    "üõ¢Ô∏è Energ√≠a y Petr√≥leo": ["shell", "chevron", "repsol", "gas", "petr√≥leo", "ofac", "licencia", "pdvsa"],
    "üí∞ Econom√≠a y Negocios": ["bcv", "d√≥lar", "tasa", "pib", "crecimiento", "consumidor", "arancel"],
    "üá∫üá∏ Relaciones Venezuela-EE.UU.": ["trump", "estados unidos", "uni√≥n", "sanciones", "washington", "marco rubio"]
}

def analizar_impacto(titulo, texto):
    """Genera an√°lisis profundo basado en el contexto de 2026."""
    texto_min = (titulo + " " + texto).lower()
    if "fiscal" in texto_min or "devoe" in texto_min:
        return "**IMPLICACI√ìN ESTRAT√âGICA:** La renovaci√≥n del Poder Ciudadano busca generar confianza para el levantamiento de sanciones operativas y normalizar la interlocuci√≥n judicial internacional."
    if "shell" in texto_min or "gas" in texto_min:
        return "**IMPLICACI√ìN ESTRAT√âGICA:** El inicio de exportaciones de gas marca la diversificaci√≥n de la matriz de ingresos del Estado y el retorno de la seguridad jur√≠dica para capitales europeos."
    if "amnist√≠a" in texto_min:
        return "**IMPLICACI√ìN ESTRAT√âGICA:** La ejecuci√≥n de las 179 liberaciones iniciales es un hito de cumplimiento clave exigido por Washington para mantener la vigencia de las licencias petroleras."
    if "trump" in texto_min or "socio" in texto_min:
        return "**IMPLICACI√ìN ESTRAT√âGICA:** El giro pragm√°tico de EE.UU. hacia un 'Realismo Econ√≥mico' prioriza el suministro energ√©tico seguro sobre la presi√≥n diplom√°tica."
    return "**AN√ÅLISIS:** Evento en desarrollo con impacto moderado en la estabilidad de corto plazo."

# --- MOTOR DE B√öSQUEDA Y EXTRACCI√ìN ---
def buscar_inteligencia(periodo_codigo):
    hallazgos = []
    vistos_links = set()
    queries = [
        'Venezuela ("Fiscal General" OR "Larry Devoe" OR "renuncia") "2026"',
        'Venezuela (Shell OR gas OR "Licencia" OR PDVSA) "2026"',
        'Venezuela (Amnist√≠a OR "presos pol√≠ticos") "2026"',
        'Venezuela (Trump OR "Estado de la Uni√≥n" OR "Washington") "2026"'
    ]
    
    for q in queries:
        try:
            url = f"https://news.google.com/rss/search?q={q.replace(' ', '+')}&hl=es-419&gl=VE&ceid=VE:es-419&tbs=qdr:{periodo_codigo}"
            r = requests.get(url, timeout=10)
            sopa = BeautifulSoup(r.text, 'xml')
            for item in sopa.find_all('item')[:8]:
                link = item.link.get_text()
                if link not in vistos_links:
                    titulo = item.title.get_text().split(" - ")[0]
                    try:
                        art = Article(link, language='es')
                        art.download(); art.parse()
                        cuerpo = art.text[:600]
                    except:
                        cuerpo = "Detalles disponibles en la fuente original."
                    
                    hallazgos.append({
                        "titulo": titulo,
                        "link": link,
                        "cuerpo": cuerpo,
                        "impacto": analizar_impacto(titulo, cuerpo)
                    })
                    vistos_links.add(link)
        except: continue
    return hallazgos

# --- INTERFAZ DE USUARIO (SIDEBAR) ---
st.sidebar.title("üõ°Ô∏è Public Go App")
st.sidebar.markdown("Plataforma de Inteligencia Estrat√©gica v38.0")
periodo_user = st.sidebar.selectbox("Periodo de consulta", ["Hoy", "√öltima Semana"])
codigo_p = "d" if periodo_user == "Hoy" else "w"

st.sidebar.divider()
st.sidebar.markdown("**Indicadores Clave (Feb 2026)**")
st.sidebar.metric("Tasa BCV (Est.)", "Bs. 414.04", "+1.2%")
st.sidebar.metric("Proyecci√≥n PIB 2026", "10%", "+2.5%")

# --- CUERPO PRINCIPAL ---
st.title("Intelligence Dashboard")
st.caption(f"Actualizado al: {datetime.now().strftime('%d/%m/%Y %H:%M')}")

if st.button("üöÄ Actualizar An√°lisis"):
    with st.spinner("Analizando coyuntura estrat√©gica..."):
        data = buscar_inteligencia(codigo_p)
        
        # Agrupaci√≥n por Secciones
        for nombre_sec, keywords in SECCIONES.items():
            noticias_sec = [n for n in data if any(k in n['titulo'].lower() for k in keywords)]
            
            if noticias_sec:
                st.subheader(nombre_sec)
                for noticia in noticias_sec:
                    with st.expander(f"üìå {noticia['titulo'].upper()}"):
                        st.write(noticia['cuerpo'])
                        st.success(noticia['impacto'])
                        st.markdown(f"[üîó Abrir fuente original]({noticia['link']})")
                st.divider()
else:
    st.info("Seleccione los par√°metros y presione el bot√≥n para iniciar el monitoreo.")

# Pie de p√°gina institucional
st.markdown("---")
st.markdown("<center>¬© 2026 Public Go Consulting | Confidencial</center>", unsafe_allow_html=True)
